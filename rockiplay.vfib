{"name":"Rocki Player","type":"virtual_device","properties":{"deviceIcon":5,"currentIcon":"5","log":"","logTemp":"","mainLoop":"fibaro:debug(\"Updating info\")\n\nlocal selfId = fibaro:getSelfId();\nlocal ip = fibaro:get(selfId, \"IPAddress\")\nlocal port = fibaro:get(selfId, 'TCPPort');\n\n-- Get player name\nlocal ws = Net.FHttp(ip)\nlocal respName = ws:GET(\"/name\") \n\nlocal tcpSocket = Net.FTcpSocket(ip, port) \n\nfibaro:debug(\"Rocki player: \" .. ip .. \":\" .. port)\nfibaro:debug(\"Name: \" .. respName)\n\n-- Get track info\npayload = [[POST /upnp/control/rendertransport1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:AVTransport:1#GetPositionInfo\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 310\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:GetPositionInfo xmlns:u=\"urn:schemas-upnp-org:service:AVTransport:1\"><InstanceID>0</InstanceID></u:GetPositionInfo></s:Body></s:Envelope>0x0D0x0A0x0D0x0A]] \nbytes, errorcode = tcpSocket:write(payload) \nfibaro:sleep(100)\nstate = tcpSocket:read() \n\nlocal trackURI = state:match(\"<TrackURI>(.+)</TrackURI>\") \nlocal relTime = state:match(\"<RelTime>(.+)</RelTime>\") \n\n--fibaro:debug(\"Track: \" .. trackURI)\n--fibaro:debug(\"Time: \" .. relTime)\ntcpSocket:disconnect()\n\n-- Get volume info\ntcpSocket = Net.FTcpSocket(ip, port) \npayload = [[POST /upnp/control/rendercontrol1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:RenderingControl:1#GetVolume\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 328\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:GetVolume xmlns:u=\"urn:schemas-upnp-org:service:RenderingControl:1\"><InstanceID>0</InstanceID><Channel>Master</Channel></u:GetVolume></s:Body></s:Envelope>]] \nbytes, errorcode = tcpSocket:write(payload) \nfibaro:sleep(200)\nstate = tcpSocket:read() \n\nlocal volume = state:match(\"<CurrentVolume>(.+)</CurrentVolume>\") \n\n--fibaro:debug(\"Volume: \" .. volume)\n\ntcpSocket:disconnect()\n\ntcpSocket = Net.FTcpSocket(ip, port) \npayload = [[POST /upnp/control/rendertransport1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:AVTransport:1#GetTransportInfo\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 312\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:GetTransportInfo xmlns:u=\"urn:schemas-upnp-org:service:AVTransport:1\"><InstanceID>0</InstanceID></u:GetTransportInfo></s:Body></s:Envelope>]] \nbytes, errorcode = tcpSocket:write(payload) \nfibaro:sleep(200)\nstate = tcpSocket:read() \nlocal statusCode = state:match(\"<CurrentTransportState>(.+)</CurrentTransportState>\") \n\n--fibaro:debug(\"Status: \" .. statusCode)\n\ntcpSocket:disconnect()\n\n-- Set Values\nfibaro:debug(\"Updating GUI\")\n\nif (statusCode == nil)\nthen\n  fibaro:call(selfId, \"setProperty\", \"ui.LabelPlayingState.value\", \"\")\nelse\n\tfibaro:call(selfId, \"setProperty\", \"ui.LabelPlayingState.value\", statusCode)\nend\n\nif (respName == nil)\nthen\n  fibaro:call(selfId, \"setProperty\", \"ui.LabelPlayerName.value\", \"\")\nelse\n  fibaro:call(selfId, \"setProperty\", \"ui.LabelPlayerName.value\", respName)\nend\n\nif (trackURI == nil)\nthen\n  fibaro:call(selfId, \"setProperty\", \"ui.LabelTrack.value\", \"\")\nelse\n\tfibaro:call(selfId, \"setProperty\", \"ui.LabelTrack.value\", trackURI:sub(1,22))  \nend\n\nif (relTime == nil)\nthen\n\tfibaro:call(selfId, \"setProperty\", \"ui.LabelTime.value\", \"\")\nelse  \n\tfibaro:call(selfId, \"setProperty\", \"ui.LabelTime.value\", relTime)\nend\n\nif (volume == nill)\nthen\n  fibaro:call(selfId, \"setProperty\", \"ui.SliderVolume.value\", \"\")\nelse\n  fibaro:call(selfId, \"setProperty\", \"ui.SliderVolume.value\", volume)\nend\nfibaro:debug(\"All done\")\n\nif (statusCode == \"PLAYING\")\nthen\n   fibaro:setGlobal(\"BathroomRadio\", \"Playing\")\nelse\n  fibaro:setGlobal(\"BathroomRadio\", \"Silent\")\nend\n  \n\n\n\nfibaro:sleep(1000*10)","ui.Label13.value":"","ui.LabelPlayerName.value":"ROCKI_Bathroom","ui.LabelPlayingState.value":"STOPPED","ui.LabelTime.value":"00:00:00","ui.LabelTrack.value":"http://http-live.sr.se","ui.SliderVolume.value":50,"visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Player name","name":"LabelPlayerName","favourite":false,"main":false}]},{"type":"label","elements":[{"id":2,"lua":false,"waitForResponse":false,"caption":"Status","name":"LabelPlayingState","favourite":false,"main":false}]},{"type":"label","elements":[{"id":3,"lua":false,"waitForResponse":false,"caption":"Track","name":"LabelTrack","favourite":true,"main":true}]},{"type":"label","elements":[{"id":4,"lua":false,"waitForResponse":false,"caption":"Time","name":"LabelTime","favourite":true,"main":false}]},{"type":"slider","elements":[{"id":5,"lua":false,"waitForResponse":false,"caption":"Volume","name":"SliderVolume","msg":"POST /upnp/control/rendercontrol1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:RenderingControl:1#SetVolume\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 363\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:SetVolume xmlns:u=\"urn:schemas-upnp-org:service:RenderingControl:1\"><InstanceID>0</InstanceID><Channel>Master</Channel><DesiredVolume>_sliderValue_</DesiredVolume></u:SetVolume></s:Body></s:Envelope>0x0D0x0A0x0D0x0A","buttonIcon":5,"value":50,"favourite":false,"main":true}]},{"type":"button","elements":[{"id":6,"lua":false,"waitForResponse":false,"caption":"Mute","name":"ButtonMute","empty":false,"msg":"POST /upnp/control/rendercontrol1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:RenderingControl:1#SetMute\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 353\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:SetMute xmlns:u=\"urn:schemas-upnp-org:service:RenderingControl:1\"><InstanceID>0</InstanceID><Channel>Master</Channel><DesiredMute>1</DesiredMute></u:SetMute></s:Body></s:Envelope>0x0D0x0A0x0D0x0A","buttonIcon":5,"favourite":false,"main":false},{"id":7,"lua":false,"waitForResponse":false,"caption":"Unmute","name":"ButtonUnmute","empty":false,"msg":"POST /upnp/control/rendercontrol1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:RenderingControl:1#SetMute\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 353\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:SetMute xmlns:u=\"urn:schemas-upnp-org:service:RenderingControl:1\"><InstanceID>0</InstanceID><Channel>Master</Channel><DesiredMute>0</DesiredMute></u:SetMute></s:Body></s:Envelope>0x0D0x0A0x0D0x0A","buttonIcon":5,"favourite":false,"main":false}]},{"type":"button","elements":[{"id":8,"lua":false,"waitForResponse":false,"caption":"Play","name":"ButtonPlay","empty":false,"msg":"POST /upnp/control/rendertransport1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:AVTransport:1#Play\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 305\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:Play xmlns:u=\"urn:schemas-upnp-org:service:AVTransport:1\"><InstanceID>0</InstanceID><Speed>1</Speed></u:Play></s:Body></s:Envelope>0x0D0x0A0x0D0x0A","buttonIcon":5,"favourite":false,"main":false},{"id":9,"lua":false,"waitForResponse":false,"caption":"Pause","name":"ButtonPause","empty":false,"msg":"POST /upnp/control/rendertransport1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:AVTransport:1#Pause\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 291\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:Pause xmlns:u=\"urn:schemas-upnp-org:service:AVTransport:1\"><InstanceID>0</InstanceID></u:Pause></s:Body></s:Envelope>0x0D0x0A0x0D0x0A","buttonIcon":5,"favourite":false,"main":false},{"id":10,"lua":false,"waitForResponse":false,"caption":"Stop","name":"ButtonStop","empty":false,"msg":"POST /upnp/control/rendertransport1 HTTP/1.1\nSOAPACTION: \"urn:schemas-upnp-org:service:AVTransport:1#Stop\"\nCONTENT-TYPE: text/xml ; charset=\"utf-8\"\nContent-Length: 289\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><s:Envelope s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\"><s:Body><u:Stop xmlns:u=\"urn:schemas-upnp-org:service:AVTransport:1\"><InstanceID>0</InstanceID></u:Stop></s:Body></s:Envelope>0x0D0x0A0x0D0x0A","buttonIcon":5,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":11,"lua":false,"waitForResponse":false,"caption":"Presets","name":"Label13","favourite":false,"main":false}]},{"type":"button","elements":[{"id":12,"lua":true,"waitForResponse":false,"caption":"SR P3","name":"Button41","empty":false,"msg":"local stream = \"http://http-live.sr.se/p3-mp3-192\"\n\nlocal selfId = fibaro:getSelfId();\nlocal ip = fibaro:get(selfId, \"IPAddress\")\n\nlocal url = \"/cgi-bin/rocki.cgi?Play=upnp&Host=127.0.0.1&Port=49153&URL=\" .. stream .. \"&Duration=99:59:59.999\"\n\nlocal ws = Net.FHttp(ip, 80)\nlocal resp = ws:GET(url) \n\n\nfibaro:setGlobal(\"Bathroom_LastChan\", 12)","buttonIcon":7,"favourite":false,"main":true},{"id":13,"lua":true,"waitForResponse":false,"caption":"SR P4","name":"Button42","empty":false,"msg":"local stream = \"http://http-live.sr.se/p4kronoberg-mp3-192\"\n\nlocal selfId = fibaro:getSelfId();\nlocal ip = fibaro:get(selfId, \"IPAddress\")\n\nlocal url = \"/cgi-bin/rocki.cgi?Play=upnp&Host=127.0.0.1&Port=49153&URL=\" .. stream .. \"&Duration=99:59:59.999\"\n\nlocal ws = Net.FHttp(ip, 80)\nlocal resp = ws:GET(url) \n\nfibaro:setGlobal(\"Bathroom_LastChan\", 13)\n","buttonIcon":8,"favourite":false,"main":false},{"id":14,"lua":true,"waitForResponse":false,"caption":"Bandit","name":"Button43","empty":false,"msg":"local stream = \"http://stream-ice.mtgradio.com:8080/stat_bandit\"\n\nlocal selfId = fibaro:getSelfId();\nlocal ip = fibaro:get(selfId, \"IPAddress\")\n\nlocal url = \"/cgi-bin/rocki.cgi?Play=upnp&Host=127.0.0.1&Port=49153&URL=\" .. stream .. \"&Duration=99:59:59.999\"\n\nlocal ws = Net.FHttp(ip, 80)\nlocal resp = ws:GET(url) \n\nfibaro:setGlobal(\"Bathroom_LastChan\", 14)","buttonIcon":9,"favourite":false,"main":false}]},{"type":"button","elements":[{"id":15,"lua":true,"waitForResponse":false,"caption":"MixMega","name":"Button51","empty":false,"msg":"local stream = \"http://194.16.21.227:8000/mix_gbg_se_mp3\"\n\nlocal selfId = fibaro:getSelfId();\nlocal ip = fibaro:get(selfId, \"IPAddress\")\n\nlocal url = \"/cgi-bin/rocki.cgi?Play=upnp&Host=127.0.0.1&Port=49153&URL=\" .. stream .. \"&Duration=99:59:59.999\"\n\nlocal ws = Net.FHttp(ip, 80)\nlocal resp = ws:GET(url) \n\nfibaro:setGlobal(\"Bathroom_LastChan\", 15)","buttonIcon":10,"favourite":false,"main":false},{"id":16,"lua":true,"waitForResponse":false,"caption":"RixFM","name":"Button52","empty":false,"msg":"local stream = \"http://stream-ice.mtgradio.com:8080/stat_rix_fm\"\n\nlocal selfId = fibaro:getSelfId();\nlocal ip = fibaro:get(selfId, \"IPAddress\")\n\nlocal url = \"/cgi-bin/rocki.cgi?Play=upnp&Host=127.0.0.1&Port=49153&URL=\" .. stream .. \"&Duration=99:59:59.999\"\n\nlocal ws = Net.FHttp(\"192.168.1.194\", 80)\nlocal resp = ws:GET(url) \n\nfibaro:setGlobal(\"Bathroom_LastChan\", 16)","buttonIcon":11,"favourite":false,"main":false},{"id":17,"lua":true,"waitForResponse":false,"caption":"NRJ","name":"Button53","empty":false,"msg":"--http://icecast.omroep.nl/3fm-alternative-mp3\n\nlocal streamURL = \"http://194.16.21.227:8000/nrj_se_mp3\"\n\nlocal selfId = fibaro:getSelfId();\nlocal ip = fibaro:get(selfId, \"IPAddress\")\n\n--local cmd = 'curl \"http://' .. ip .. '/cgi-bin/rocki.cgi?Play=upnp&Host=127.0.0.1&Port=49153&URL=' .. streamURL .. '&Duration=99:59:59.999\" -H \"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\" -H \"Connection: keep-alive\" -H \"Accept-Encoding: gzip, deflate, sdch\" -H \"Referer: http://127.0.0.1\" -H \"Accept-Language: en-US,en;q=0.8\" -H \"User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36\" --compressed'\nlocal cmd = 'curl \"http://' .. ip .. '/cgi-bin/rocki.cgi?Play=upnp&Host=127.0.0.1&Port=49153&URL=' .. streamURL .. '&Duration=99:59:59.999\"'\n\nfibaro:debug(cmd)\nlocal resp = os.execute(cmd) \nfibaro:debug(resp)\n\nfibaro:setGlobal(\"Bathroom_LastChan\", 17)","buttonIcon":12,"favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}
